name: Sync All Missing Branches (Full Scan)

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process New Branches
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="Princeboy520/ManifestHub"
          MY_REPO="MKNETID/Temp-Repo"

          # 1. AMBIL SEMUA DAFTAR BRANCH (Looping Pagination)
          echo "Fetching all branch names from source (this may take a while)..."
          PAGE=1
          touch all_source_branches.txt
          while : ; do
            echo "Fetching page $PAGE..."
            RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$SOURCE_REPO/branches?per_page=100&page=$PAGE")
            
            # Jika response kosong atau error, berhenti
            if [ "$RESPONSE" == "[]" ] || [ -z "$RESPONSE" ]; then break; fi
            
            echo "$RESPONSE" | jq -r '.[].name' >> all_source_branches.txt
            
            # Limitasi: GitHub API punya rate limit 5000/jam. 
            # 65rb branch / 100 = 650 request. Masih aman.
            ((PAGE++))
          done

          # 2. KOMPARASI DATA
          echo "Comparing with data-manifest.json..."
          sort all_source_branches.txt -o all_source_branches.txt
          jq -r '.branches[]' data-manifest.json | sort > manifest_branches.txt
          
          # Ambil branch yang ada di source tapi TIDAK ada di manifest
          NEW_BRANCHES=$(comm -23 all_source_branches.txt manifest_branches.txt)

          if [ -z "$NEW_BRANCHES" ]; then
            echo "No new branches to sync."
            exit 0
          fi

          # 3. PROSES SYNC
          # Catatan: Kita batasi proses sync file-nya per run agar tidak timeout (6 jam limit)
          COUNT=0
          LIMIT=1000 # Anda bisa menaikkan ini jika ingin lebih banyak per jalan

          for S_BRANCH in $NEW_BRANCHES; do
            if [ "$COUNT" -ge "$LIMIT" ]; then 
              echo "Reached batch limit ($LIMIT). Stop for now."
              break 
            fi

            echo "Syncing Branch: $S_BRANCH"

            # Create branch locally
            git checkout main
            git checkout -b "$S_BRANCH"

            # Ambil .lua file
            API_URL="https://api.github.com/repos/$SOURCE_REPO/contents?ref=$S_BRANCH"
            FILE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" "$API_URL")
            FILES=$(echo "$FILE_DATA" | jq -r '.[] | select(.name | endswith(".lua")) | .download_url' 2>/dev/null)

            if [ -z "$FILES" ] || [ "$FILES" == "null" ]; then
              git checkout main && git branch -D "$S_BRANCH"
              continue
            fi

            for FILE_URL in $FILES; do
              FILENAME=$(basename "$FILE_URL")
              curl -sL -o "$FILENAME" "$FILE_URL"
              git add "$FILENAME"
            done

            git commit -m "Sync $S_BRANCH"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${MY_REPO}.git" "$S_BRANCH"

            # Update JSON di branch main
            git checkout main
            jq --arg b "$S_BRANCH" '.branches += [$b] | .total_branches = (.branches | length)' data-manifest.json > temp.json && mv temp.json data-manifest.json
            git add data-manifest.json
            git commit -m "Update manifest: $S_BRANCH"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${MY_REPO}.git" main

            ((COUNT++))
          done
