name: Sync Public Lua Branches

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Cukup 1 karena kita akan manipulasi branch secara spesifik

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests

      - name: Run Sync Script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MY_REPO: "MKNETID/Temp-Repo"
          PUBLIC_REPOS: "hammerwebsite12/sojogames2,Princeboy520/ManifestHub,SPIN0ZAi/SB_manifest_DB,dvahana2424-web/sojogamesdatabase1"
        run: |
          python - <<EOF
          import os
          import json
          import requests
          import subprocess

          token = os.getenv('GH_TOKEN')
          headers = {'Authorization': f'token {token}'}
          public_repos = os.getenv('PUBLIC_REPOS').split(',')
          
          # 1. Load manifest
          with open('data-manifest.json', 'r') as f:
              manifest = json.load(f)
          existing_branches = set(manifest['branches'])

          new_found_branches = []
          
          def git_run(args):
              return subprocess.run(args, capture_output=True, text=True)

          # Config Git
          git_run(["git", "config", "user.name", "github-actions[bot]"])
          git_run(["git", "config", "user.email", "github-actions[bot]@users.noreply.github.com"])

          for repo in public_repos:
              print(f"Checking events for: {repo}")
              # Ambil event terbaru (PushEvent) untuk melihat branch mana yang baru di-push
              event_url = f"https://api.github.com/repos/{repo}/events?per_page=50000"
              res = requests.get(event_url, headers=headers)
              
              if res.status_code != 200:
                  continue

              events = res.json()
              target_branches = set()
              
              for event in events:
                  if event['type'] == 'PushEvent':
                      ref = event['payload'].get('ref', '')
                      if 'refs/heads/' in ref:
                          b_name = ref.replace('refs/heads/', '')
                          if b_name.isdigit():
                              target_branches.add(b_name)

              for branch_name in target_branches:
                  if branch_name not in existing_branches:
                      print(f"Detected new activity on branch: {branch_name}")
                      
                      # Coba ambil file .lua
                      file_url = f"https://raw.githubusercontent.com/{repo}/{branch_name}/{branch_name}.lua"
                      file_res = requests.get(file_url)
                      
                      if file_res.status_code == 200:
                          # Buat Orphan Branch dengan cara yang lebih aman
                          git_run(["git", "checkout", "--orphan", branch_name])
                          git_run(["git", "rm", "-rf", "."])
                          
                          with open(f"{branch_name}.lua", "wb") as f:
                              f.write(file_res.content)
                          
                          git_run(["git", "add", f"{branch_name}.lua"])
                          git_run(["git", "commit", "-m", f"Add {branch_name}.lua from {repo}"])
                          
                          push = subprocess.run(["git", "push", "origin", branch_name])
                          
                          if push.returncode == 0:
                              new_found_branches.append(branch_name)
                              existing_branches.add(branch_name)
                              print(f"Successfully pushed branch: {branch_name}")
                          
                          git_run(["git", "checkout", "main"])
                      
                      if len(new_found_branches) >= 50000: break
              if len(new_found_branches) >= 50000: break

          # 2. Update manifest
          if new_found_branches:
              git_run(["git", "checkout", "main"])
              
              # Logika sorting yang diperbaiki:
              # Pisahkan yang angka dan yang teks (seperti 'main')
              numeric_branches = [b for b in existing_branches if b.isdigit()]
              other_branches = [b for b in existing_branches if not b.isdigit()]
              
              # Urutkan angka secara numerik, lalu tambahkan branch teks di akhir/awal
              sorted_list = sorted(numeric_branches, key=int) + sorted(other_branches)
              
              manifest['branches'] = sorted_list
              manifest['total_branches'] = len(sorted_list)
              
              with open('data-manifest.json', 'w') as f:
                  json.dump(manifest, f, indent=2)
              
              git_run(["git", "add", "data-manifest.json"])
              git_run(["git", "commit", "-m", f"Update manifest: added {len(new_found_branches)} branches"])
              git_run(["git", "push", "origin", "main"])
              print(f"Manifest updated with {len(new_found_branches)} new entries.")
          else:
              print("No new branches to sync.")
