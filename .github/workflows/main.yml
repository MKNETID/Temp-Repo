name: Sync via Direct Remote Push

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Direct Sync
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          # 1. Tambahkan remote sumber
          git remote add source https://github.com/Princeboy520/ManifestHub.git
          echo "Fetching source metadata..."
          git fetch source --prune --quiet

          # 2. Ambil daftar branch baru (Komparasi)
          git branch -r | grep 'source/' | sed 's/  source\///' | grep -v 'HEAD' | sort > all_source_branches.txt
          jq -r '.branches[]' data-manifest.json | sort > manifest_branches.txt
          NEW_BRANCHES=$(comm -23 all_source_branches.txt manifest_branches.txt)

          if [ -z "$NEW_BRANCHES" ]; then
            echo "Semua branch sudah sinkron."
            exit 0
          fi

          # 3. Proses Sinkronisasi (Direct Push)
          COUNT=0
          LIMIT=300 # Gunakan angka kecil dulu untuk tes stabilitas
          SUCCESS_LIST=()

          for S_BRANCH in $NEW_BRANCHES; do
            if [ "$COUNT" -ge "$LIMIT" ]; then break; fi

            echo "Pushing branch: $S_BRANCH"
            
            # Perintah sakti: push langsung dari remote source ke remote origin (repo Anda)
            # Format: git push <destination_remote> <source_ref>:<target_branch_name>
            if git push "https://x-access-token:${GH_TOKEN}@github.com/MKNETID/Temp-Repo.git" "refs/remotes/source/$S_BRANCH:refs/heads/$S_BRANCH" --force; then
              SUCCESS_LIST+=("$S_BRANCH")
              ((COUNT++))
            else
              echo "Gagal memindahkan branch $S_BRANCH"
            fi
          done

          # 4. Update Manifest Sekaligus
          if [ ${#SUCCESS_LIST[@]} -gt 0 ]; then
            echo "Updating manifest for ${#SUCCESS_LIST[@]} branches..."
            
            # Gunakan Python atau jq untuk update JSON massal agar tidak lambat
            for B in "${SUCCESS_LIST[@]}"; do
              jq --arg b "$B" '.branches += [$b]' data-manifest.json > temp.json && mv temp.json data-manifest.json
            done
            
            jq '.total_branches = (.branches | length)' data-manifest.json > temp.json && mv temp.json data-manifest.json

            git add data-manifest.json
            git commit -m "Auto-sync: Added ${#SUCCESS_LIST[@]} branches"
            git push "https://x-access-token:${GH_TOKEN}@github.com/MKNETID/Temp-Repo.git" main
          fi
