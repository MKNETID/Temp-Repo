name: Sync External Branches

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Memberikan izin eksplisit untuk menulis ke repo
    
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          # Sangat penting menggunakan token custom agar punya akses push
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Menghindari error "fatal: unsafe repository"
          git config --global --add safe.directory /github/workspace

      - name: Process Branches
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="Princeboy520/ManifestHub"
          MY_REPO="MKNETID/Temp-Repo"
          
          # Ambil daftar branch lokal & remote agar pengecekan akurat
          echo "Fetching existing branches..."
          git fetch --all --prune
          
          # Ambil daftar branch di repo saya
          EXISTING_BRANCHES=$(git branch -r | sed 's/origin\///' | tr -d ' ')

          # Baca data-manifest.json
          BRANCHES_TO_SYNC=$(jq -r '.branches[]' data-manifest.json)

          # Counter untuk mencegah timeout (proses 500 per run agar aman)
          COUNT=0
          LIMIT=500 

          for BRANCH in $BRANCHES_TO_SYNC; do
            if [ "$COUNT" -ge "$LIMIT" ]; then
               echo "Limit batch $LIMIT tercapai. Berhenti agar tidak timeout."
               break
            fi

            # Cek jika branch sudah ada
            if echo "$EXISTING_BRANCHES" | grep -qxw "$BRANCH"; then
              echo "Branch $BRANCH sudah ada, skip."
              continue
            fi

            echo "--------------------------------------"
            echo "Processing Branch: $BRANCH"

            # Reset ke main sebelum buat branch baru
            git checkout main
            git checkout -b "$BRANCH"

            # Ambil konten file dari API GitHub
            API_URL="https://api.github.com/repos/$SOURCE_REPO/contents?ref=$BRANCH"
            FILE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" "$API_URL")
            
            # Cari file .lua
            FILES=$(echo "$FILE_DATA" | jq -r '.[] | select(.name | endswith(".lua")) | .download_url' 2>/dev/null)

            if [ -z "$FILES" ] || [ "$FILES" == "null" ]; then
              echo "Skipping: Tidak ada file .lua di branch $BRANCH sumber."
              git checkout main
              git branch -D "$BRANCH"
              continue
            fi

            for FILE_URL in $FILES; do
              FILENAME=$(basename "$FILE_URL")
              curl -sL -o "$FILENAME" "$FILE_URL"
              git add "$FILENAME"
            done

            git commit -m "Auto-sync: Add lua for branch $BRANCH"
            
            # Gunakan format URL dengan token untuk autentikasi push yang pasti berhasil
            git push "https://x-access-token:${GH_TOKEN}@github.com/${MY_REPO}.git" "$BRANCH"
            
            echo "Successfully synced: $BRANCH"
            COUNT=$((COUNT + 1))
          done
