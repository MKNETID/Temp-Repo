name: Sync via Full Repo Fetch

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch and Sync
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          # 1. Daftarkan repo sumber sebagai remote tambahan
          git remote add source https://github.com/Princeboy520/ManifestHub.git
          
          # 2. Ambil semua daftar branch dari remote source tanpa download file dulu (hemat storage)
          echo "Fetching branch list from source..."
          git fetch source --prune

          # 3. List semua branch dari source dan bersihkan namanya
          # Kita ambil branch yang ada di 'remotes/source/'
          git branch -r | grep 'source/' | sed 's/  source\///' | grep -v 'HEAD' | sort > all_source_branches.txt

          # 4. Ambil daftar dari manifest lokal
          jq -r '.branches[]' data-manifest.json | sort > manifest_branches.txt

          # 5. Cari branch yang belum ada di manifest
          NEW_BRANCHES=$(comm -23 all_source_branches.txt manifest_branches.txt)

          if [ -z "$NEW_BRANCHES" ]; then
            echo "Semua sudah sinkron."
            exit 0
          fi

          # 6. Proses Sinkronisasi
          COUNT=0
          LIMIT=1000 # Batasi per run agar tidak kena limit push GitHub

          for S_BRANCH in $NEW_BRANCHES; do
            if [ "$COUNT" -ge "$LIMIT" ]; then break; fi

            echo "Syncing: $S_BRANCH"

            # Checkout branch dari source ke lokal dengan nama yang sama
            # Kita gunakan --track agar git tahu sumbernya
            if git checkout -b "$S_BRANCH" "source/$S_BRANCH" --quiet; then
              
              # Push branch ke repo Anda (origin)
              git push "https://x-access-token:${GH_TOKEN}@github.com/MKNETID/Temp-Repo.git" "$S_BRANCH"

              # Kembali ke main untuk update JSON
              git checkout main --quiet
              jq --arg b "$S_BRANCH" '.branches += [$b] | .total_branches = (.branches | length)' data-manifest.json > temp.json && mv temp.json data-manifest.json
              
              # Commit update manifest agar tidak diulang
              git add data-manifest.json
              git commit -m "Manifest update: $S_BRANCH" --quiet
              
              ((COUNT++))
            else
              echo "Gagal checkout $S_BRANCH, skip."
              git checkout main --quiet
            fi
          done

          # Push semua perubahan manifest di main sekaligus
          git push "https://x-access-token:${GH_TOKEN}@github.com/MKNETID/Temp-Repo.git" main
