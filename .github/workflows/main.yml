name: Sync Missing Branches

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process New Branches Only
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="Princeboy520/ManifestHub"
          MY_REPO="MKNETID/Temp-Repo"
          
          # 1. Ambil semua branch dari repo SUMBER via API (Paging mungkin diperlukan jika > 100)
          # Untuk efisiensi, kita ambil 100 branch terbaru dulu
          echo "Fetching branches from source..."
          SOURCE_BRANCHES=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$SOURCE_REPO/branches?per_page=100" | jq -r '.[].name')

          # 2. Ambil daftar branch yang sudah tercatat di data-manifest.json Anda
          # Kita gunakan jq untuk mendapatkan array branches mentah
          ALREADY_SYNCED=$(jq -r '.branches[]' data-manifest.json)

          COUNT=0
          LIMIT=50 # Batasi jumlah per run agar stabil

          for S_BRANCH in $SOURCE_BRANCHES; do
            if [ "$COUNT" -ge "$LIMIT" ]; then break; fi
            
            # Cek apakah S_BRANCH sudah ada di data-manifest.json
            if echo "$ALREADY_SYNCED" | grep -qxw "$S_BRANCH"; then
              echo "Branch $S_BRANCH sudah terdaftar di JSON, skip."
              continue
            fi

            echo "New branch found: $S_BRANCH. Syncing..."

            # Buat branch baru
            git checkout main
            git checkout -b "$S_BRANCH"

            # Ambil file .lua
            API_URL="https://api.github.com/repos/$SOURCE_REPO/contents?ref=$S_BRANCH"
            FILES=$(curl -s -H "Authorization: token $GH_TOKEN" "$API_URL" | jq -r '.[] | select(.name | endswith(".lua")) | .download_url')

            if [ -z "$FILES" ] || [ "$FILES" == "null" ]; then
              echo "No lua files in $S_BRANCH."
              git checkout main
              git branch -D "$S_BRANCH"
              continue
            fi

            for FILE_URL in $FILES; do
              FILENAME=$(basename "$FILE_URL")
              curl -sL -o "$FILENAME" "$FILE_URL"
              git add "$FILENAME"
            done

            git commit -m "Add new branch $S_BRANCH from source"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${MY_REPO}.git" "$S_BRANCH"

            # --- BAGIAN PENTING: Update data-manifest.json agar tidak diambil lagi ---
            # Menambahkan branch baru ke array 'branches' dan mengupdate 'total_branches'
            jq --arg b "$S_BRANCH" '.branches += [$b] | .total_branches = (.branches | length)' data-manifest.json > temp.json && mv temp.json data-manifest.json
            
            git checkout main
            git add data-manifest.json
            git commit -m "Update manifest: Added $S_BRANCH"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${MY_REPO}.git" main

            COUNT=$((COUNT + 1))
          done
