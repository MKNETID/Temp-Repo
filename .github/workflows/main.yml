name: Sync External Branches

on:
  workflow_dispatch: # Jalankan manual

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process Branches
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="Princeboy520/ManifestHub"
          MY_REPO="MKNETID/Temp-Repo"
          
          # 1. Ambil daftar branch yang sudah ada di repo saya untuk filter
          echo "Fetching existing branches..."
          git fetch --prune
          EXISTING_BRANCHES=$(git branch -r | sed 's/origin\///' | tr -d ' ')

          # 2. Baca data-manifest.json (asumsi ada di root)
          # Menggunakan jq untuk mengambil array branches
          BRANCHES_TO_SYNC=$(jq -r '.branches[]' data-manifest.json)

          for BRANCH in $BRANCHES_TO_SYNC; do
            # Cek apakah branch sudah ada
            if echo "$EXISTING_BRANCHES" | grep -qxw "$BRANCH"; then
              echo "Branch $BRANCH sudah ada, skip."
              continue
            fi

            echo "Processing Branch: $BRANCH"

            # Buat branch baru dari main
            git checkout main
            git checkout -b "$BRANCH"

            # 3. Ambil file .lua dari repo sumber menggunakan API GitHub (lebih efisien daripada clone)
            # Kita cari file .lua di branch sumber yang namanya sama dengan branch
            FILE_CONTENT=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$SOURCE_REPO/contents?ref=$BRANCH")
            
            # Download semua file .lua yang ditemukan di branch tersebut
            FILES=$(echo "$FILE_CONTENT" | jq -r '.[] | select(.name | endswith(".lua")) | .download_url')

            if [ -z "$FILES" ] || [ "$FILES" == "null" ]; then
              echo "Tidak ada file .lua di branch $BRANCH sumber."
              git checkout main
              git branch -D "$BRANCH"
              continue
            fi

            for FILE_URL in $FILES; do
              FILENAME=$(basename "$FILE_URL")
              curl -sL -o "$FILENAME" "$FILE_URL"
              git add "$FILENAME"
            done

            # Commit dan Push
            git commit -m "Add lua files for branch $BRANCH"
            git push https://x-access-token:${GH_TOKEN}@github.com/${MY_REPO}.git "$BRANCH"
            
            echo "Successfully synced branch $BRANCH"
            
            # Kembali ke main untuk iterasi berikutnya
            git checkout main
          done
