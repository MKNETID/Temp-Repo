name: Sync Update Manifest

on:
  #schedule:
  #  - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  sync-and-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.API_TOKEN }}
          fetch-depth: 0 # Penting: Ambil semua branch untuk manifest nanti

      - name: Setup Git Config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync Process (Check Against External JSON)
        env:
          GH_TOKEN: ${{ secrets.API_TOKEN }}
          SOURCE_REPO: "Princeboy520/ManifestHub"
          JSON_URL: "https://raw.githubusercontent.com/MKNETID/Gemesak-Project/main/data-manifest.json"
        run: |
          # 1. Ambil daftar branch dari repo sumber (Princeboy520)
          gh api repos/$SOURCE_REPO/branches --paginate --jq '.[].name' > source_branches.txt

          # 2. Ambil daftar nama yang sudah terdaftar di JSON (MKNETID)
          # Menggunakan jq untuk mengambil array dan menyimpannya ke file teks
          curl -s $JSON_URL | jq -r '.[]' > manifest_list.txt

          # 3. Ambil daftar branch yang sudah ada di repo Anda saat ini (lokal/remote)
          git branch -r | sed 's/origin\///' | tr -d ' ' > my_existing_branches.txt

          COUNT=0
          while IFS= read -r BRANCH; do
            # Lewati jika branch kosong atau main
            if [ -z "$BRANCH" ] || [ "$BRANCH" == "main" ]; then continue; fi
            
            # CEK 1: Apakah sudah ada di data-manifest.json?
            if grep -qx "$BRANCH" manifest_list.txt; then
              echo "Skip: $BRANCH sudah terdaftar di manifest JSON."
              continue
            fi

            # CEK 2: Apakah sudah ada di repo Anda? (mencegah duplikasi jika JSON belum terupdate)
            if grep -qx "$BRANCH" my_existing_branches.txt; then
              echo "Skip: $BRANCH sudah ada di repo Anda."
              continue
            fi

            # PROSES: Jika tidak ada di JSON dan tidak ada di repo Anda, maka ambil file .lua nya
            echo "Syncing New Branch: $BRANCH"
            FILE_URL="https://raw.githubusercontent.com/$SOURCE_REPO/$BRANCH/$BRANCH.lua"
            
            mkdir -p temp_file_dir
            HTTP_STATUS=$(curl -s -L -o "temp_file_dir/$BRANCH.lua" -w "%{http_code}" "$FILE_URL")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              git checkout --orphan "$BRANCH"
              git rm -rf . --quiet > /dev/null
              mv "temp_file_dir/$BRANCH.lua" .
              git add "$BRANCH.lua"
              git commit -m "Add $BRANCH.lua (Not found in manifest)" --quiet
              git push origin "$BRANCH" --force
              COUNT=$((COUNT+1))
              git checkout -f main
            else
              echo "Failed: File $BRANCH.lua tidak ditemukan di sumber (HTTP $HTTP_STATUS)"
              git checkout -f main
            fi
            rm -rf temp_file_dir

          done < source_branches.txt
          
          echo "Selesai. Total $COUNT branch baru berhasil ditambahkan."
