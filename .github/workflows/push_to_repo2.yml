name: Individual Zip per Branch Lua

on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Mengambil seluruh branch

      - name: Process Branches and Zip Individually
        run: |
          mkdir output_zips
          
          # Ambil daftar semua branch remote (kecuali HEAD)
          branches=$(git branch -r | grep -v "origin/HEAD" | sed 's/origin\///')
          
          for branch in $branches; do
            echo "Processing branch: $branch"
            
            # Checkout ke branch terkait secara paksa
            git checkout -f $branch
            
            # Cari file .lua di branch ini
            # Kita gunakan loop jika ada lebih dari satu file .lua di satu branch
            find . -maxdepth 1 -name "*.lua" | while read -r file; do
              # Hilangkan karakter './' dari nama file
              filename=$(basename "$file")
              # Ambil nama tanpa ekstensi untuk nama ZIP (misal: 200188)
              basename="${filename%.*}"
              
              echo "Zipping $filename to ${basename}.zip"
              zip -j "output_zips/${basename}.zip" "$file"
            done
          done
          
          # Kembali ke default branch agar bisa lanjut ke step berikutnya
          git checkout main || git checkout master

      - name: Push Zips to Target Repo
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Clone repo target
          git clone https://x-access-token:${API_TOKEN}@github.com/MKNETID/temp-repo2.git target-folder

          # Pindahkan semua file ZIP dari folder output_zips ke target-folder
          cp output_zips/*.zip target-folder/

          cd target-folder
          git add *.zip
          
          # Cek jika ada perubahan sebelum commit
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update: Individual Lua Zips from branches"
            git push origin main
          else
            echo "No changes to commit"
          fi
